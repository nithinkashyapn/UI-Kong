<!doctype html>
<html lang="en">
  <head>
    <title>Kong Dashboard</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <script src="https://momentjs.com/downloads/moment.js"></script>    
    <script src="https://code.jquery.com/jquery-3.2.1.js" integrity="sha256-DZAnKJ/6XZ9si04Hgrsxu/8s717jcIzLy3oi35EouyE=" crossorigin="anonymous"></script>       
    <script src="https://use.fontawesome.com/574bd8552f.js"></script>
    <link rel="stylesheet" href="./CSS/footable.bootstrap.css">     
    <script src="./JS/footable.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
    <link rel="stylesheet" href="CSS/main.css">
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
			<a class="navbar-brand" href="index.html">Kong</a>
			<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarText" aria-controls="navbarText" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarText">
    <ul class="navbar-nav mr-auto">
        <li class="nav-item">
        <a class="nav-link" href="apis.html">API</a>
        </li>
        <li class="nav-item">
        <a class="nav-link" href="plugins.html">PLUGIN</a>
        </li>
        <li class="nav-item">
        <a class="nav-link" href="consumers.html">COMSUMER</a>
        </li>
        <li class="nav-item active">
            <a class="nav-link">LOAD BALANCER</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="certificates.html">CERTIFICATE</a>
        </li>
    </ul>
    <span class="navbar-text">
        1.0
    </span>
    </div>
    </nav>
    <div class="card-body">
        <table id="showcase-example-1" class="table" data-paging="true" data-filtering="true" data-sorting="true" data-editing="true" data-state="true" data-editing-allow-edit="false"></table>
        <!-- Editing Modal Markup -->
        <div class="modal fade" id="editor-modal" tabindex="-1" role="dialog" aria-labelledby="editor-title">
            <div class="modal-dialog" role="document">
                <form class="modal-content form-horizontal" id="editor">
                    <div class="modal-header">
                        <h4 class="modal-title" id="editor-title">Add LB</h4>
                    </div>
                    <div class="modal-body">
                        <div class="form-group required">
                            <label for="name" class="col-sm-3 control-label">Name</label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" id="name" name="name" placeholder="Name" required>
                            </div>
                        </div>
                        <div class="form-group required">
                            <label for="slots" class="col-sm-3 control-label">Slots</label>
                            <div class="col-sm-9">
                                <input type="number" class="form-control" id="slots" name="slots" placeholder="Must be greater than 100" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="col-sm-9">
                                <input type="hidden" class="form-control" id="id" name="id" placeholder="ID" required>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Save changes</button>
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
            <div class="modal-body">
                <table id="target-example-1" class="targetable" data-paging="true" data-sorting="true" data-editing="true" data-editing-allow-add="true" data-editing-allow-edit="false" data-state="true"></table>
            </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="target-modal" tabindex="-1" role="dialog" aria-labelledby="target-title">
        <div class="modal-dialog" role="document">
            <form class="modal-content form-horizontal" id="target">
                <div class="modal-body">
                    <input type="hidden" id="id" name="id"/>
                    <div class="form-group required">
                        <label for="targetname" class="col-sm-3 control-label">Target</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="targetname" name="targetname" placeholder="Target" required>
                        </div>
                    </div>
                    <div class="form-group required">
                        <label for="targetweight" class="col-sm-3 control-label">Weight</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="targetweight" name="targetweight" placeholder="Weight" required>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Save changes</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ" crossorigin="anonymous"></script>
    <script>
        jQuery(function($){

        $.getJSON('http://139.59.9.37:8001/upstreams', function(data) {
                
            for(let i=0;i<data.data.length;i++){
                data.data[i].created_at = new Date(data.data[i].created_at).toDateString();
            }

            var $modal = $('#editor-modal'),
                $editor = $('#editor'),
                $target = $('#exampleModal'),
                $editorTitle = $('#editor-title'),
                ft = FooTable.init('#showcase-example-1', {
                    columns: [
                        {
                            "name": "id",
                            "title": "ID",
                            "visible": false        
                        },
                        {
                            "name": "created_at",
                            "title": "Created"
                        },
                        {
                            "name": "name",
                            "title": "Name"
                        },
                        {
                            "name": "slots",
                            "title": "SLOTS"
                        },
                        {
                            "name":"targets",
                            "title":"TARGETS",
                            "formatter": function (value) {
                                var actions = $('<div/>')
                                var user_button = ($('<button/>', {"type":"button","class":"btn btn-dark btn-lg"})
                                .on("click", this, up)
                                )
                                .appendTo(actions); 
                                
                                return actions;
                                }
                        }
                    ],
                    rows: data.data,
                    editing: {
                        addRow: function(){
                            $modal.removeData('row');
                            $editor[0].reset();
                            $editorTitle.text('Add a new row');
                            $modal.modal('show');
                        },
                        editRow: function(row){
                            var values = row.val();
                            $editor.find('#id').val(values.id);
                            $editor.find('#created_at').val(values.created_at);
                            $editor.find('#name').val(values.name);
                            $editor.find('#slots').val(values.slots);
                            $modal.data('row', row);
                            $editorTitle.text('Edit ' + values.name + ' ?');
                            $modal.modal('show');
                        },
                        deleteRow: function(row){
                            if (confirm('Are you sure you want to delete the row?')){
                                let tu = 'http://139.59.9.37:8001/upstreams/' + row.value.id;
                                $.ajax({
                                    type: "DELETE",
                                    dataType: 'json',
                                    url: tu,
                                    success: function(e){
                                        alert("Done.");
                                        location.reload();
                                    },
                                    error: function(err){
                                        alert(err);
                                    }
                                });
                            }
                        }
                    }
                }),
                uid = 10001;
        
                $editor.on('submit', function(e){
                    if (this.checkValidity && !this.checkValidity()) return;
                    e.preventDefault();
                    var row = $modal.data('row'),
                        values = {
                            id: $editor.find('#id').val(),
                            created_at: $editor.find('#created_at').val(),
                            slots: $editor.find('#slots').val(),
                            name: $editor.find('#name').val()
                        };

                    if (row instanceof FooTable.Row){
                        alert("Already exists");
                    } else {
                        let interim = {};
                        interim.name = values.name;
                        interim.slots = values.slots;
                        if(values.slots < 100){
                            alert("Aborted.");
                        }else{
                            $.ajax({
                                type: "PUT",
                                dataType: 'json',
                                url: "http://139.59.9.37:8001/upstreams",
                                data: interim,
                                success: function(e){
                                    alert("Done.");
                                    location.reload();
                                },
                                error: function(err){
                                    alert("Error.");
                                }
                            });
                        }
                    }
                    $modal.modal('hide');
                });


                function up(e) {                    
                    e.preventDefault();
                    var $row = $(this).closest('tr'); 
                    var $prerow = $row.prevAll('tr').first();
                    var row = FooTable.getRow($row);
                    let rowey = {};
                    rowey.id = row.value.id;
                    rowey.name = row.value.name;
                    let tarurl = 'http://139.59.9.37:8001/upstreams/' + rowey.name + '/targets/active';
                    $.getJSON(tarurl, function(datatarget) {
                        jQuery(function($){
                            var $modal = $('#target-modal'),
                                $editor = $('#target'),
                                ft = FooTable.init('#target-example-1', {
                                    columns: $.get("./lbcolumns.json"),
                                    rows: datatarget.data,
                                    editing: {
                                        addRow: function(){
                                            $modal.removeData('row');
                                            $editor[0].reset();
                                            $modal.modal('show');
                                            console.log(rowey.name);
                                        },
                                        deleteRow: function(row){
                                            console.log(rowey.name);
                                            if (confirm('Are you sure you want to delete the row?')){
                                                let tu = 'http://139.59.9.37:8001/upstreams/'+rowey.name+'/targets/'+row.value.id;
                                                $.ajax({
                                                    type: "DELETE",
                                                    dataType: 'json',
                                                    url: tu,
                                                    success: function(e){
                                                        alert("Done.");
                                                        location.reload();
                                                    },
                                                    error: function(err){
                                                        alert("Error.");
                                                    }
                                                });
                                            }
                                        }
                                    }
                                }),
                                uid = 10001;

                                $editor.on('submit', function(e){
                                if (this.checkValidity && !this.checkValidity()) return;
                                e.preventDefault();
                                var row = $modal.data('row'),
                                    values = {
                                        target: $editor.find('#targetname').val(),
                                        weight: $editor.find('#targetweight').val()
                                    };
                                console.log(values);
                                if (row instanceof FooTable.Row){
                                    alert("Already there");
                                } else {
                                    let tempurl = 'http://139.59.9.37:8001/upstreams/' + rowey.name + '/targets';
                                    $.ajax({
                                        type: "POST",
                                        dataType: 'json',
                                        url: tempurl,
                                        data: values,
                                        success: function(e){
                                            alert("Done.");
                                            location.reload();
                                        },
                                        error: function(err){
                                            alert("Error.");
                                        }
                                    });
                                }
                                $modal.modal('hide');
                            });
                        });
                    });
                    $target.find('#targetid').val(rowey.id);
                    $target.find('#targetname').val(rowey.name);
                    $target.modal('show');
                }    
        });
    });
    </script>      
  </body>
</html>