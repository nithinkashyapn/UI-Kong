<!doctype html>
<html lang="en">
  <head>
    <title>Kong Dashboard</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <script type="text/javascript" src="./CONFIG/creds.js"></script>
    <script src="https://momentjs.com/downloads/moment.js"></script>    
    <script src="https://code.jquery.com/jquery-3.2.1.js" integrity="sha256-DZAnKJ/6XZ9si04Hgrsxu/8s717jcIzLy3oi35EouyE=" crossorigin="anonymous"></script>       
    <script src="https://use.fontawesome.com/574bd8552f.js"></script>
    <link rel="stylesheet" href="./CSS/footable.bootstrap.css">     
    <script src="./JS/footable.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
    <link rel="stylesheet" href="CSS/main.css">
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <a class="navbar-brand" href="index.html">Kong</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarText" aria-controls="navbarText" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarText">
    <ul class="navbar-nav mr-auto">
        <li class="nav-item">
        <a class="nav-link" href="apis.html">API</a>
        </li>
        <li class="nav-item">
        <a class="nav-link" href="consumers.html">COMSUMER</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="loadbalancers.html">LOAD BALANCER</a>
        </li>
        <li class="nav-item active">
            <a class="nav-link">CERTIFICATE</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="snis.html">SNIS</a>
        </li>
    </ul>
    <span class="navbar-text">
        1.0
    </span>
    </div>
    </nav>
    <div class="card-body">
        <table id="showcase-example-1" class="table" data-paging="true" data-filtering="true" data-sorting="true" data-editing="true" data-state="true" data-editing-allow-edit="false"></table>
        <!-- Editing Modal Markup -->
        <div class="modal fade" id="editor-modal" tabindex="-1" role="dialog" aria-labelledby="editor-title">
            <div class="modal-dialog" role="document">
                <form class="modal-content form-horizontal" id="editor">
                    <div class="modal-header">
                        <h4 class="modal-title" id="editor-title">Add CERTIFICATE</h4>
                    </div>
                    <div class="modal-body">
                        <div class="form-group required">
                            <label for="cert" class="col-sm-3 control-label">CERT</label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" id="cert" name="cert" placeholder="Certificate" required>
                            </div>
                        </div>
                        <div class="form-group required">
                            <label for="key" class="col-sm-3 control-label">KEY</label>
                            <div class="col-sm-9">
                                    <input type="text" class="form-control" id="key" name="key" placeholder="Keys" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="snis" class="col-sm-3 control-label">SNIs</label>
                            <div class="col-sm-9">
                                    <input type="text" class="form-control" id="snis" name="snis" placeholder="SNIs">
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="col-sm-9">
                                <input type="hidden" class="form-control" id="id" name="id" placeholder="ID" required>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Save changes</button>
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    </nav>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ" crossorigin="anonymous"></script>
    <script>
        jQuery(function($){

        $.getJSON( KONGIP + '/certificates', function(data) {
                
            for(let i=0;i<data.data.length;i++){
                data.data[i].created_at = new Date(data.data[i].created_at).toDateString();
            }

            var $modal = $('#editor-modal'),
                $editor = $('#editor'),
                $editorTitle = $('#editor-title'),
                ft = FooTable.init('#showcase-example-1', {
                    columns: [
                        {
                            "name": "id",
                            "title": "ID",
                            "visible": false        
                        },
                        {
                            "name": "created_at",
                            "title": "Created"
                        },
                        {
                            "name": "cert",
                            "title": "Cert"
                        },
                        {
                            "name": "key",
                            "title": "Key"
                        },
                        {
                            "name": "snis",
                            "title": "SNIs"
                        }
                    ],
                    rows: data.data,
                    editing: {
                        addRow: function(){
                            $modal.removeData('row');
                            $editor[0].reset();
                            $editorTitle.text('Add a new row');
                            $modal.modal('show');
                        },
                        editRow: function(row){
                            var values = row.val();
                            $editor.find('#id').val(values.id);
                            $editor.find('#cert').val(values.cert);
                            $editor.find('#key').val(values.key);
                            $editor.find('#snis').val(values.snis);                            
                            $modal.data('row', row);
                            $editorTitle.text('Edit ' + values.name + ' ?');
                            $modal.modal('show');
                        },
                        deleteRow: function(row){
                            if (confirm('Are you sure you want to delete the row?')){
                                let tu =  KONGIP + "/certificates/" + row.value.id;
                                $.ajax({
                                    type: "DELETE",
                                    dataType: 'json',
                                    url: tu,
                                    success: function(e){
                                        alert("Done.");
                                        location.reload();
                                    },
                                    error: function(err){
                                        alert(err);
                                    }
                                });
                            }
                        }
                    }
                }),
                uid = 10001;
        
                $editor.on('submit', function(e){
                    if (this.checkValidity && !this.checkValidity()) return;
                    e.preventDefault();
                    var row = $modal.data('row'),
                        values = {
                            id: $editor.find('#id').val(),
                            cert: $editor.find('#cert').val(),
                            key: $editor.find('#key').val(),
                            snis: $editor.find('#snis').val() 
                        };

                    if (row instanceof FooTable.Row){
                        console.log("Here");
                        let interim = {};
                        interim.cert = values.cert;
                        interim.key = values.key;
                        interim.snis = values.snis;
                        let tu =  KONGIP + "/certificates/" + values.id;
                        $.ajax({
                            type: "PATCH",
                            dataType: 'json',
                            url: tu,
                            data: interim,
                            success: function(e){
                                alert("Done.");
                                location.reload();
                            },
                            error: function(err){
                                alert(err);
                            }
                        });
                    } else {
                        console.log("Here");
                        let interim = {};
                        interim.cert = values.cert;
                        interim.key = values.key;
                        interim.snis = values.snis;
                        $.ajax({
                            type: "POST",
                            dataType: 'json',
                            url: KONGIP + "/certificates/",
                            data: interim,
                            success: function(e){
                                alert("Done.");
                                location.reload();
                            },
                            error: function(err){
                                alert(err);
                            }
                        });
                    }
                    $modal.modal('hide');
                });

        });
    });

    window.onload = function() {
        if(!sessionStorage.getItem('admin')){
            window.open('index.html', '_self');
        }
    };
    </script>      
  </body>
</html>